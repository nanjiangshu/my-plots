<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BigPicture uploading tests</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #fdfdfd; }
    h1 { text-align: center; margin-bottom: 0.3em; }
    p.description { text-align: center; max-width: 800px; margin: 0 auto 2em; font-size: 1.1em; color: #444; }
    .folder { margin-bottom: 40px; white-space: nowrap; overflow-x: auto; }
    .folder h2 { margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    img { max-width: 600px; margin: 10px; display: inline-block; }
  </style>
</head>
<body>
  <h1>ðŸ“Š BigPicture uploading tests</h1>
  <p class="description">
    Each test uploads three datasets, each containing 100 files, using the sda-cli tool. 
    The datasets consist of files with the following sizes: 2MB, 20MB, and 200MB.
  </p>
  <div id="gallery"></div>

  <script>
    const repo = "nanjiangshu/my-plots";
    const apiUrl = `https://api.github.com/repos/${repo}/contents/plots/`;

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) return null;
      return res.json();
    }

    async function loadGallery() {
      const root = await fetchJSON(apiUrl);
      if (!root) return;

      // Filter only timestamped folders
      let folders = root.filter(f => f.type === "dir");

      // Sort folders descending by name (timestamps: latest first)
      folders.sort((a, b) => b.name.localeCompare(a.name));

      for (const folder of folders) {
        const files = await fetchJSON(apiUrl + folder.name);
        if (!files) continue;

        const images = files.filter(f => f.name.endsWith(".png"));
        if (images.length === 0) continue;

        // Try to load info.json if available
        const infoFile = files.find(f => f.name === "info.json");
        let headerText = folder.name;
        if (infoFile) {
          const info = await fetchJSON(infoFile.download_url);
          if (info && info.UploadedFrom) {
            let location = "";
            try {
              const ipInfo = await fetchJSON(`https://ipapi.co/${info.UploadedFrom}/json/`);
              if (ipInfo && !ipInfo.error) {
                location = `, ${ipInfo.country_name || ""}${ipInfo.city ? ", " + ipInfo.city : ""}`;
              }
            } catch (e) {
              // ignore lookup errors
            }
            headerText = `${folder.name} â€” uploaded from: ${info.UploadedFrom}${location}`;
          }
        }

        const section = document.createElement("div");
        section.className = "folder";
        section.innerHTML = `<h2>${headerText}</h2>`;
        for (const img of images) {
          const el = document.createElement("img");
          el.src = `https://raw.githubusercontent.com/${repo}/main/${img.path}`;
          el.alt = img.name;
          section.appendChild(el);
        }

        document.getElementById("gallery").appendChild(section);
      }
    }

    loadGallery();
  </script>
</body>
</html>
